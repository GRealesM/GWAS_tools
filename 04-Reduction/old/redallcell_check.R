# This script is intended to check what went wrong in reducing stuff
library(data.table)
library(magrittr)

orig  <- dir("../../02-Processed/", pattern = "*hg38.tsv.gz")
orig <- gsub("-hg38.tsv.gz","", orig)
orig <- data.table(idx = 1:length(orig), file = orig)

targ  <- dir("../../03-Bases/cell_basis_v2/reduced_datasets/", pattern = "*ft.tsv")
targ <- gsub("-ft.tsv","", targ)

rogue <- orig[!file %in% targ,]

# Extract the offending numbers as a string
paste(rogue$idx, collapse=",")

# We had some files that had less SNPs that I would like them to have (ie. basis datasets that I checked independently and they had the full SNPs) so let's do another round
system("wc -l ../../03-Bases/cell_basis_v2/reduced_datasets/* > ./cb2reducedlines")
ln <- fread("cb2reducedlines")
ln  <- ln[1:(nrow(ln)-1),]
ln[,V1:=V1-1][,V2:=gsub("../../03-Bases/cell_basis_v2/reduced_datasets/","", V2)][,idx:=1:nrow(ln)][,group:=(idx - (idx %% 10) + 1)]
ln.sub <- ln[V1 < 1661,]
# FinnGenR2 (1378) and FinnGenR3 (1382) have similar SNPs, so aren't suspicious of failure, so I'll remove them
ln.sub <- ln.sub[!V2 %like% "FinnGenR",]
paste(ln.sub$idx, collapse=",")

# It's ok that some dataset have less than 100% match with the manifest.
# Let's see how many of them are below 80%
nrow(ln.sub[V1 < 1661 * 0.8]) / nrow(ln) 
# [1] 0.03702463
# 3.7%, which is more or less what we've seen before, let's take a quick look at which those datasets are

ln.sub[V1 < .8*1661,]$V2
#   [1] "ANS_Cortes_23749187_1-ft.tsv"            
#   [2] "AST_Anantharaman_22188591_1-ft.tsv"      
#   [3] "BCA1_Traglia_30134952_2-ft.tsv"          
#   [4] "BCA1_Traglia_30134952_3-ft.tsv"          
#   [5] "CCL19_Enroth_25147954_1-ft.tsv"          
#   [6] "CCL20_Traglia_30134952_2-ft.tsv"         
#   [7] "CCL20_Traglia_30134952_3-ft.tsv"         
#   [8] "CCL21_Traglia_30134952_2-ft.tsv"         
#   [9] "CCL21_Traglia_30134952_3-ft.tsv"         
#  [10] "CCL23_Traglia_30134952_2-ft.tsv"         
#  [11] "CCL23_Traglia_30134952_3-ft.tsv"         
#  [12] "CCL25_Traglia_30134952_2-ft.tsv"         
#  [13] "CCL25_Traglia_30134952_3-ft.tsv"         
#  [14] "CD244_Hoglund_31727947_1-ft.tsv"         
#  [15] "CD40_Hoglund_31727947_1-ft.tsv"          
#  [16] "CD40_Hoglund_31727947_2-ft.tsv"          
#  [17] "CD40L_Enroth_25147954_1-ft.tsv"          
#  [18] "CD_Brant_27693347_1-ft.tsv"              
#  [19] "CD_DeLange_28067908_1-ft.tsv"            
#  [20] "CD_Liu_26192919_1-ft.tsv"                
#  [21] "CD_Liu_26192919_2-ft.tsv"                
#  [22] "CD_Liu_26192919_3-ft.tsv"                
#  [23] "CD_Liu_26192919_4-ft.tsv"                
#  [24] "CD_Liu_26192919_5-ft.tsv"                
#  [25] "CEL_Trynka_22057235_1-ft.tsv"            
#  [26] "CERC_Leo_28806749_1-ft.tsv"              
#  [27] "COVID19hosp_COVID19HGI_20210107_2-ft.tsv"
#  [28] "COVID19hpop_COVID19HGI_20210107_1-ft.tsv"
#  [29] "COVID19hpop_COVID19HGI_20210107_2-ft.tsv"
#  [30] "COVID19pop_COVID19HGI_20210107_2-ft.tsv" 
#  [31] "COVID19pos_Rivas_20200422_1-ft.tsv"      
#  [32] "COVID19pos_Rivas_20200422_2-ft.tsv"      
#  [33] "COVID19pos_Rivas_20200422_3-ft.tsv"      
#  [34] "COVID19pos_Rivas_20200422_4-ft.tsv"      
#  [35] "COVID19sev_Rivas_20200422_1-ft.tsv"      
#  [36] "COVID19vsev_COVID19HGI_20200930_1-ft.tsv"
#  [37] "COVID19vsev_COVID19HGI_20210107_1-ft.tsv"
#  [38] "COVID19vsev_COVID19HGI_20210107_2-ft.tsv"
#  [39] "COVID19vsev_COVID19HGI_20210107_3-ft.tsv"
#  [40] "COVID19vsev_COVID19HGI_20210107_4-ft.tsv"
#  [41] "COVID19vsev_Ellinghaus_32558485_1-ft.tsv"
#  [42] "COVID19vsev_Ellinghaus_32558485_2-ft.tsv"
#  [43] "CTACK_Traglia_30134952_2-ft.tsv"         
#  [44] "CTACK_Traglia_30134952_3-ft.tsv"         
#  [45] "CX3CL1_Traglia_30134952_2-ft.tsv"        
#  [46] "CX3CL1_Traglia_30134952_3-ft.tsv"        
#  [47] "CXCL5_Enroth_25147954_1-ft.tsv"          
#  [48] "CXCL5_Traglia_30134952_2-ft.tsv"         
#  [49] "CXCL5_Traglia_30134952_3-ft.tsv"         
#  [50] "CXCL6_Traglia_30134952_2-ft.tsv"         
#  [51] "CXCL6_Traglia_30134952_3-ft.tsv"         
#  [52] "DEATH_UKB_Rivas_20200422_1-ft.tsv"       
#  [53] "EOE_Kottyan_25017104_1-ft.tsv"           
#  [54] "EOPL_Astle_27863252_1-ft.tsv"            
#  [55] "EOPL_Vuckovic_32888494_1-ft.tsv"         
#  [56] "EOT1_Traglia_30134952_1-ft.tsv"          
#  [57] "EOT1_Traglia_30134952_2-ft.tsv"          
#  [58] "EOT1_Traglia_30134952_3-ft.tsv"          
#  [59] "EOT1_Traglia_30134952_4-ft.tsv"          
#  [60] "EOT2_Enroth_25147954_1-ft.tsv"           
#  [61] "EOT2_Traglia_30134952_2-ft.tsv"          
#  [62] "EOT2_Traglia_30134952_3-ft.tsv"          
#  [63] "EOT3_Traglia_30134952_2-ft.tsv"          
#  [64] "EOT3_Traglia_30134952_3-ft.tsv"          
#  [65] "EPCAM_Enroth_25147954_1-ft.tsv"          
#  [66] "ESEL_Enroth_25147954_1-ft.tsv"           
#  [67] "GMCSF_Traglia_30134952_1-ft.tsv"         
#  [68] "GMCSF_Traglia_30134952_2-ft.tsv"         
#  [69] "GMCSF_Traglia_30134952_3-ft.tsv"         
#  [70] "GMCSF_Traglia_30134952_4-ft.tsv"         
#  [71] "GROA_Traglia_30134952_2-ft.tsv"          
#  [72] "GROA_Traglia_30134952_3-ft.tsv"          
#  [73] "GROB_Traglia_30134952_2-ft.tsv"          
#  [74] "GROB_Traglia_30134952_3-ft.tsv"          
#  [75] "HBVV_Nishida_29534301_1-ft.tsv"          
#  [76] "I309_Traglia_30134952_2-ft.tsv"          
#  [77] "I309_Traglia_30134952_3-ft.tsv"          
#  [78] "IBD_Liu_26192919_2-ft.tsv"               
#  [79] "IBD_Liu_26192919_3-ft.tsv"               
#  [80] "IBD_Liu_26192919_4-ft.tsv"               
#  [81] "IBD_Liu_26192919_5-ft.tsv"               
#  [82] "IFNG_Traglia_30134952_1-ft.tsv"          
#  [83] "IFNG_Traglia_30134952_2-ft.tsv"          
#  [84] "IFNG_Traglia_30134952_3-ft.tsv"          
#  [85] "IFNG_Traglia_30134952_4-ft.tsv"          
#  [86] "IL10_Traglia_30134952_1-ft.tsv"          
#  [87] "IL10_Traglia_30134952_2-ft.tsv"          
#  [88] "IL10_Traglia_30134952_3-ft.tsv"          
#  [89] "IL10_Traglia_30134952_4-ft.tsv"          
#  [90] "IL12_Enroth_25147954_1-ft.tsv"           
#  [91] "IL12p40_Traglia_30134952_1-ft.tsv"       
#  [92] "IL12p40_Traglia_30134952_4-ft.tsv"       
#  [93] "IL12p70_Traglia_30134952_1-ft.tsv"       
#  [94] "IL12p70_Traglia_30134952_2-ft.tsv"       
#  [95] "IL12p70_Traglia_30134952_3-ft.tsv"       
#  [96] "IL12p70_Traglia_30134952_4-ft.tsv"       
#  [97] "IL12_Reales_up_1-ft.tsv"                 
#  [98] "IL13_Traglia_30134952_1-ft.tsv"          
#  [99] "IL13_Traglia_30134952_2-ft.tsv"          
# [100] "IL13_Traglia_30134952_3-ft.tsv"          
# [101] "IL13_Traglia_30134952_4-ft.tsv"          
# [102] "IL16_Traglia_30134952_2-ft.tsv"          
# [103] "IL16_Traglia_30134952_3-ft.tsv"          
# [104] "IL17RB_Enroth_25147954_1-ft.tsv"         
# [105] "IL17_Traglia_30134952_1-ft.tsv"          
# [106] "IL17_Traglia_30134952_4-ft.tsv"          
# [107] "IL1A_Traglia_30134952_1-ft.tsv"          
# [108] "IL1A_Traglia_30134952_4-ft.tsv"          
# [109] "IL1B_Traglia_30134952_1-ft.tsv"          
# [110] "IL1B_Traglia_30134952_2-ft.tsv"          
# [111] "IL1B_Traglia_30134952_3-ft.tsv"          
# [112] "IL1B_Traglia_30134952_4-ft.tsv"          
# [113] "IL1RA_Traglia_30134952_1-ft.tsv"         
# [114] "IL1RA_Traglia_30134952_4-ft.tsv"         
# [115] "IL2_Traglia_30134952_1-ft.tsv"           
# [116] "IL2_Traglia_30134952_2-ft.tsv"           
# [117] "IL2_Traglia_30134952_3-ft.tsv"           
# [118] "IL2_Traglia_30134952_4-ft.tsv"           
# [119] "IL4_Traglia_30134952_1-ft.tsv"           
# [120] "IL4_Traglia_30134952_2-ft.tsv"           
# [121] "IL4_Traglia_30134952_3-ft.tsv"           
# [122] "IL4_Traglia_30134952_4-ft.tsv"           
# [123] "IL6RA_Enroth_25147954_1-ft.tsv"          
# [124] "IL6_Traglia_30134952_1-ft.tsv"           
# [125] "IL6_Traglia_30134952_2-ft.tsv"           
# [126] "IL6_Traglia_30134952_3-ft.tsv"           
# [127] "IL6_Traglia_30134952_4-ft.tsv"           
# [128] "IL7_Traglia_30134952_1-ft.tsv"           
# [129] "IL7_Traglia_30134952_4-ft.tsv"           
# [130] "IL8_Traglia_30134952_1-ft.tsv"           
# [131] "IL8_Traglia_30134952_2-ft.tsv"           
# [132] "IL8_Traglia_30134952_3-ft.tsv"           
# [133] "IL8_Traglia_30134952_4-ft.tsv"           
# [134] "IP10_Enroth_25147954_1-ft.tsv"           
# [135] "IP10_Reales_up_1-ft.tsv"                 
# [136] "IP10_Traglia_30134952_1-ft.tsv"          
# [137] "IP10_Traglia_30134952_2-ft.tsv"          
# [138] "IP10_Traglia_30134952_3-ft.tsv"          
# [139] "IP10_Traglia_30134952_4-ft.tsv"          
# [140] "IP9_Traglia_30134952_2-ft.tsv"           
# [141] "IP9_Traglia_30134952_3-ft.tsv"           
# [142] "JIA_Hinks_23603761_1-ft.tsv"             
# [143] "K11_Enroth_25147954_1-ft.tsv"            
# [144] "MCP1_Traglia_30134952_1-ft.tsv"          
# [145] "MCP1_Traglia_30134952_2-ft.tsv"          
# [146] "MCP1_Traglia_30134952_3-ft.tsv"          
# [147] "MCP1_Traglia_30134952_4-ft.tsv"          
# [148] "MCP2_Hoglund_31727947_1-ft.tsv"          
# [149] "MCP2_Traglia_30134952_2-ft.tsv"          
# [150] "MCP2_Traglia_30134952_3-ft.tsv"          
# [151] "MCP3_AholaOlli_27989323_1-ft.tsv"        
# [152] "MCP3_Hoglund_31727947_1-ft.tsv"          
# [153] "MCP3_Reales_up_1-ft.tsv"                 
# [154] "MCP3_Traglia_30134952_2-ft.tsv"          
# [155] "MCP3_Traglia_30134952_3-ft.tsv"          
# [156] "MCP4_Traglia_30134952_2-ft.tsv"          
# [157] "MCP4_Traglia_30134952_3-ft.tsv"          
# [158] "MDC_Traglia_30134952_2-ft.tsv"           
# [159] "MDC_Traglia_30134952_3-ft.tsv"           
# [160] "MDD_Wray_29700475_2-ft.tsv"              
# [161] "MIA_Enroth_25147954_1-ft.tsv"            
# [162] "MICA_Enroth_25147954_1-ft.tsv"           
# [163] "MIF_Traglia_30134952_2-ft.tsv"           
# [164] "MIF_Traglia_30134952_3-ft.tsv"           
# [165] "MIG_Traglia_30134952_2-ft.tsv"           
# [166] "MIG_Traglia_30134952_3-ft.tsv"           
# [167] "MIP1A_Traglia_30134952_1-ft.tsv"         
# [168] "MIP1A_Traglia_30134952_2-ft.tsv"         
# [169] "MIP1A_Traglia_30134952_3-ft.tsv"         
# [170] "MIP1A_Traglia_30134952_4-ft.tsv"         
# [171] "MIP1B_Traglia_30134952_1-ft.tsv"         
# [172] "MIP1B_Traglia_30134952_4-ft.tsv"         
# [173] "MIP1D_Traglia_30134952_2-ft.tsv"         
# [174] "MIP1D_Traglia_30134952_3-ft.tsv"         
# [175] "MIP3B_Traglia_30134952_2-ft.tsv"         
# [176] "MIP3B_Traglia_30134952_3-ft.tsv"         
# [177] "MS_IMSGC_24076602_1-ft.tsv"              
# [178] "MS_IMSGC_30343897_1-ft.tsv"              
# [179] "NAR_Faraco_23459209_1-ft.tsv"            
# [180] "PBC_Nakamura_23000144_1-ft.tsv"          
# [181] "PLAV_Chen_32888493_2-ft.tsv"             
# [182] "PLAV_Chen_32888493_6-ft.tsv"             
# [183] "PSA_Aterido_30552173_1-ft.tsv"           
# [184] "PSA_Aterido_30552173_2-ft.tsv"           
# [185] "PSO_Feng_19680446_1-ft.tsv"              
# [186] "PSO_Hirata_29031612_1-ft.tsv"            
# [187] "PSO_Tsoi_23143594_1-ft.tsv"              
# [188] "RBCW_Chen_32888493_2-ft.tsv"             
# [189] "RBCW_Chen_32888493_4-ft.tsv"             
# [190] "RBCW_Chen_32888493_5-ft.tsv"             
# [191] "RBCW_Chen_32888493_6-ft.tsv"             
# [192] "RBCW_Vuckovic_32888494_1-ft.tsv"         
# [193] "RD_Boutin_31816047_1-ft.tsv"             
# [194] "RI_ARDS_FLU_PNE_Rivas_20200422_1-ft.tsv" 
# [195] "SCYB16_Traglia_30134952_2-ft.tsv"        
# [196] "SCYB16_Traglia_30134952_3-ft.tsv"        
# [197] "SDF1AB_Traglia_30134952_2-ft.tsv"        
# [198] "SDF1AB_Traglia_30134952_3-ft.tsv"        
# [199] "sIL2RA_Traglia_30134952_1-ft.tsv"        
# [200] "sIL2RA_Traglia_30134952_4-ft.tsv"        
# [201] "SLE_SLEGEN_18204446_1-ft.tsv"            
# [202] "T1D_OnengutGumuscu_25751624_1-ft.tsv"    
# [203] "T2D_Gaulton_26551672_1-ft.tsv"           
# [204] "TAK_Renauer_25604533_1-ft.tsv"           
# [205] "TAK_Renauer_25604533_2-ft.tsv"           
# [206] "TARC_Traglia_30134952_2-ft.tsv"          
# [207] "TARC_Traglia_30134952_3-ft.tsv"          
# [208] "TNFa_Traglia_30134952_1-ft.tsv"          
# [209] "TNFa_Traglia_30134952_2-ft.tsv"          
# [210] "TNFa_Traglia_30134952_3-ft.tsv"          
# [211] "TNFa_Traglia_30134952_4-ft.tsv"          
# [212] "UC_Julia_25082827_1-ft.tsv"              
# [213] "UC_Liu_26192919_2-ft.tsv"                
# [214] "UC_Liu_26192919_3-ft.tsv"                
# [215] "UC_Liu_26192919_4-ft.tsv"                
# [216] "UC_Liu_26192919_5-ft.tsv"                
# [217] "VEGFD_Enroth_25147954_1-ft.tsv"          
# [218] "VITD_Traglia_32047095_1-ft.tsv"          
# [219] "VITD_Traglia_32047095_2-ft.tsv"          
# [220] "VITD_Traglia_32047095_3-ft.tsv"          
# [221] "VITD_Traglia_32047095_4-ft.tsv"         

# After several rounds of re-running doubtful files, I think this is the best we can get.
