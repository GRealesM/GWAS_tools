#### SPECIALS LOG FILE #####
Created: 2020/01/27
Author: Guillermo Reales

Description: This file is intended to log all changes implemented to special files prior to further processing, as well as any relevant information about particular files for reproducibility and better debugging down the line.
Note that this file was started after initial file processing, so it may not be comprehensive in terms of including everything the files went through from download to projected.
For more information about specific files, please check Main_GWAS_table and README files in 99-Technical_useful_files/

- ADHD_LaskySu_18937294_1-fc.tsv.gz

Last reviewed: 2020-01-27
The problem with this file is REF/ALT assignment.
After revising it, it's still unclear which one is the effect allele.
Skipped for now 


- ADHD_Neale_20732625_1-hc.tsv.gz

Last reviewed: 2020-01-27
The problem with this file was the lack of OR and BETA, so they were calculated using Zscore, frequencies and sample sizes.

I tried to calculate them following a publication, using the line below 

awk 'BEGIN {FS=OFS="\t"}NR==1{print $0, "BETA", "SE"}NR>1{if($8 != ".") {beta = $6/sqrt(2*$8*(1 - $8) * (5415 + ($6 ** 2))); se = 1/sqrt(2*$8*(1 - $8) * (5415 + ($6 ** 2))); print $0, beta, se; next} {print $0, "NA", "NA"}}' ADH_Neale_20732625_1-hc.tsv | head | column -t

However, I discussed with Chris that the best way to calculate beta and se would be:
se = sqrt( 1 / (2 * N * f * (1 - f) * s * (1 - s)) )
beta-hat = z * se
where N = total sample size, s= n.cases/N, f=MAF

However, the study included cases, controls, and trios, and it wasn't clear to me how to proceed.
Skipped until further discussion.


- EGPAANCAn_Lyons_doi101101491837_1-hc.tsv.gz, EGPA_Lyons_doi101101491837_1-hc.tsv.gz, & EGPAMPO_Lyons_doi101101491837_1-hc.tsv.gz

Last reviewed: 2020-01-27

The three files have the same problem: After looking at the paper and associated readme files, I couldn't determine beyond reasonable doubt REF/ALT alleles. 
On a side note, OR reported in the paper (Table 2) do not correspond to the BETA reported in the files.
Skipped until further discussion.


- ASTAO_Ferreira_30929738_1-hg38.tsv.gz & ASTCO_Ferreira_30929738_1-hg38.tsv.gz

Last reviewed: 2020-02-05

These files came with a typo in origin: OR was reported as BETA. 
I caught this typo at projection, and initially thought it was a problem of REF/ALT misassign (I chose ALLELE1 as ALT and ALLELE0 as REF, as was suggested by reading the paper), but then I realized what the true error was.
I first downloaded the files that can be found in 97-Archive, but after I while I discovered that there were harmonized versions in GWAS catalog, so I downloaded them and run the rest of the pipeline on them.
Later I realized this typo was not caught by the GWAS catalog guys, who wrongly flipped this fake Beta for some alleles.
I took the two files in 97-Archive/, renamed columns as
ALLELE1 -> ALT
ALLELE0 -> REF
A1FREQ -> ALT_FREQ
BETA -> OR
P_BOLT_LMM_INF -> P

zcat AOA_Ferreira_30929738_1.tsv.gz | sed -e 's/ALLELE1/ALT/' -e 's/ALLELE0/REF/' -e 's/A1FREQ/ALT_FREQ/' -e 's/BETA/OR/' -e 's/P_BOLT_LMM_INF/P/' | gzip > ASTAO_Ferreira_30929738_1.tsv.gz
zcat COA_Ferreira_30929738_1.tsv.gz | sed -e 's/ALLELE1/ALT/' -e 's/ALLELE0/REF/' -e 's/A1FREQ/ALT_FREQ/' -e 's/BETA/OR/' -e 's/P_BOLT_LMM_INF/P/' | gzip > ASTCO_Ferreira_30929738_1.tsv.gz

After this, I normally run full_pipeline-v2.sh on both files and updated them at 04-Liftovered


- Tian_28928442 files

Last reviewed: 2020-02-05

This files come in a very specific format, which require another file to provide the alleles and rsids.

I first copied them from Archive to 01-Renamed, which contained all pipeline files
cp 97-Archive/*Tian_28928442* ../01-Renamed/

Since these files are in the old system, I changed them to the new one (but only the ones which changed their denomination, to avoid self-overwriting!)
mv CPX_Tian_28928442_1.tsv.gz CPOX_Tian_28928442_1.tsv.gz
mv HAV_Tian_28928442_1.tsv.gz HEPA_Tian_28928442_1.tsv.gz
mv HBV_Tian_28928442_1.tsv.gz HEPB_Tian_28928442_1.tsv.gz
mv MNU_Tian_28928442_1.tsv.gz IM_Tian_28928442_1.tsv.gz
mv MEA_Tian_28928442_1.tsv.gz MEAS_Tian_28928442_1.tsv.gz
mv MUM_Tian_28928442_1.tsv.gz MUMPS_Tian_28928442_1.tsv.gz
mv PNE_Tian_28928442_1.tsv.gz PNEU_Tian_28928442_1.tsv.gz
mv RHF_Tian_28928442_1.tsv.gz RFEV_Tian_28928442_1.tsv.gz
mv SCF_Tian_28928442_1.tsv.gz SCAF_Tian_28928442_1.tsv.gz
mv STT_Tian_28928442_1.tsv.gz STHR_Tian_28928442_1.tsv.gz
mv TBP_Tian_28928442_1.tsv.gz TBpos_Tian_28928442_1.tsv.gz
mv TON_Tian_28928442_1.tsv.gz TONS_Tian_28928442_1.tsv.gz
mv YEA_Tian_28928442_1.tsv.gz YINF_Tian_28928442_1.tsv.gz

I wrote a script to filter the annotation file from the original, and merge such file with Tian files (Fix_Tian_28928442_files.sh). 
After running this script, I delete the original files (in 01-Renamed) and run the full_pipeline-v2.sh on the new, merged ones.
Note: effect here means BETA, although in the paper they sometimes report OR or BETA, depending on the trait.


- ASTER_Ferreira_29083406_1-fc.tsv.gz, ASTE_Ferreira_29083406_1-fc.tsv.gz, ASTR_Ferreira_29083406_1-fc.tsv.gz, and RHEC_Ferreira_29083406_1-fc.tsv.gz.

Last Reviewed: 2020-02-06

These files came with the same issue as Tian_28928442 files, so the solution is the same.
I copied the original files from the Archive to 01-Renamed for processing.

cd 97-Archive/
cp AER_Ferreira_29083406_1.tsv.gz ASR_Ferreira_29083406_1.tsv.gz ASE_Ferreira_29083406_1.tsv.gz REC_Ferreira_29083406_1-fc.tsv.gz ../01-Renamed/
cd ../01-Renamed
mv ASE_Ferreira_29083406_1.tsv.gz ASTE_Ferreira_29083406_1.tsv.gz
mv AER_Ferreira_29083406_1.tsv.gz ASTER_Ferreira_29083406_1.tsv.gz
mv ASR_Ferreira_29083406_1.tsv.gz ASTR_Ferreira_29083406_1.tsv.gz
mv REC_Ferreira_29083406_1.tsv.gz RHEC_Ferreira_29083406_1.tsv.gz
./Fix_Ferreira_29083406_files.sh


- ALR_Ishigaki_doi101101795948_1

Last Reviewed: 2020-02-06

The problem with this file is that original data came in two files (one using autosomes, and other with X chromosome info).
I had merged these two files previously, but since they don't have the same number of columns, pipeline didn't work. 
Thus, I downloaded them again and reprocess:

wget jenger.riken.jp/88/
tar -xvf index.html
RScript --vanilla Remerge_Riken.R Pollinosis.auto.rsq07.mac10.txt.gz Pollinosis.chrx.rsq07.mac10.txt.gz ALR_Ishigaki_doi101101795948_1.tsv
sed -e 's/Allele1/REF/g' -e 's/Allele2/ALT/g' ALR_Ishigaki_doi101101795948_1.tsv | gzip > ALR_Ishigaki_doi101101795948_1.tsv.gz
./full_pipeline-v2.sh

I moved "unprocessed" file to Archive, and processed (hg38) to Processed.


- AST_Ishigaki_doi101101795948_1

Last Reviewed: 2020-02-06

The problem with this file is that original data came in two files (one using autosomes, and other with X chromosome info).
I had merged these two files previously, but since they don't have the same number of columns, pipeline didn't work. 
Thus, I downloaded them again and reprocess:

wget jenger.riken.jp/30/
tar -xvf index.html
Rscript --vanilla Remerge_Riken.R Asthma.auto.rsq07.mac10.txt.gz Asthma.chrx.rsq07.mac10.txt.gz AST_Ishigaki_doi101101795948_1.tsv
sed -e 's/Allele1/REF/g' -e 's/Allele2/ALT/g' AST_Ishigaki_doi101101795948_1.tsv | gzip > AST_Ishigaki_doi101101795948_1.tsv.gz
./full_pipeline-v2.sh

I moved "unprocessed" file to Archive, and processed (hg38) to Processed.

- ATD_Ishigaki_doi101101795948_1

Last Reviewed: 2020-02-06

The problem with this file is that original data came in two files (one using autosomes, and other with X chromosome info).
I had merged these two files previously, but since they don't have the same number of columns, pipeline didn't work. 
Thus, I downloaded them again and reprocess:

wget jenger.riken.jp/32/
tar -xvf index.html
Rscript --vanilla Remerge_Riken.R AD.auto.rsq07.mac10.txt.gz AD.chrx.rsq07.mac10.txt.gz ATD_Ishigaki_doi101101795948_1.tsv
sed -e 's/Allele1/REF/g' -e 's/Allele2/ALT/g' ATD_Ishigaki_doi101101795948_1.tsv | gzip > ATD_Ishigaki_doi101101795948_1.tsv.gz
./full_pipeline-v2.sh

I moved "unprocessed" file to Archive, and processed (hg38) to Processed.



- RA_Ishigaki_doi101101795948_1

Last Reviewed: 2020-02-07

The problem with this file is that original data came in two files (one using autosomes, and other with X chromosome info).
I had merged these two files previously, but since they don't have the same number of columns, pipeline didn't work. 
Thus, I downloaded them again and reprocess:

wget jenger.riken.jp/93/;
tar -xvf index.html
Rscript --vanilla Remerge_Riken.R RA.auto.rsq07.mac10.txt.gz RA.chrx.rsq07.mac10.txt.gz RA_Ishigaki_doi101101795948_1.tsv;
sed -e 's/Allele1/REF/g' -e 's/Allele2/ALT/g' RA_Ishigaki_doi101101795948_1.tsv | gzip > RA_Ishigaki_doi101101795948_1.tsv.gz;
./full_pipeline-v2.sh;

I moved "unprocessed" file to Archive, and processed (hg38) to Processed.


- T2D_Ishigaki_doi101101795948_1

Last Reviewed: 2020-02-07

The problem with this file is that original data came in two files (one using autosomes, and other with X chromosome info).
I had merged these two files previously, but since they don't have the same number of columns, pipeline didn't work. 
Thus, I downloaded them again and reprocess:

wget jenger.riken.jp/95/;
tar -xvf index.html
Rscript --vanilla Remerge_Riken.R T2D.auto.rsq07.mac10.txt.gz T2D.chrx.rsq07.mac10.txt.gz T2D_Ishigaki_doi101101795948_1.tsv;
sed -e 's/Allele1/REF/g' -e 's/Allele2/ALT/g' T2D_Ishigaki_doi101101795948_1.tsv | gzip > T2D_Ishigaki_doi101101795948_1.tsv.gz;
./full_pipeline-v2.sh;

I moved "unprocessed" file to Archive, and processed (hg38) to Processed.


- CDP_Lee_28067912_1

Last Reviewed: 2020-02-07

The problem with this file is that my early scripts messed up with it, leaving bottom rows in a crazy state. 
Thus, I downloaded it again and reprocessed it.

wget ftp://ftp.ebi.ac.uk/pub/databases/gwas/summary_statistics/LeeJC_28067912_GCST004053/CD_prognosis_GWA_results.csv.zip
unzip CD_prognosis_GWA_results.csv.zip
mv CD_prognosis_GWA_results.csv CDP_Lee_28067912_1.tsv

I realised when running the pipeline that some BP positions had scientific notation, which made liftover get stuck. I fixed this like this, include this check in v3 of the pipeline

cat CDP_Lee_28067912_1.tsv | awk 'BEGIN{FS=OFS="\t"}NR>1{$3=sprintf("%i", $3)}7' | gzip > CDP_Lee_28067912_1.tsv.gz
mv CDP_Lee_28067912_1.tsv.gz ../97-Archive/

From the paper, I inferred that allele_A is REF and allele_B is ALT. I manually edited the file using vim prior to pipeline
In addition, some unexpected bug at processing liftover results made merge to fail.
Specifically, when converting from *-lo_output.bed to *-lo_output2.bed, sed removes chr from lo-output.bed. This is because liftOver needs CHR to have "chr"+number, while our files don't.
However, in this particular file, instead of having traditional rs00000 format, we have chrCHR:BP format. Thus, that sed removes "chr" from SNPID column too, preventing a correct merge.
I did the following to correct it, and included it in version v3 of the pipeline.


awk 'BEGIN{FS=OFS="\t"}{sub("chr", "",$1); print $4,$1,$2}' CDP_Lee_28067912_1-lo-output.bed | sed '1i SNPID\tCHR38\tBP38' > CDP_Lee_28067912_1-lo-output2.bed 
join -a2 -e'NA' -t $'\t' --nocheck-order -o auto CDP_Lee_28067912_1-lo-output2.bed tmp_formerging1.tsv | gzip  > CDP_Lee_28067912_1-hg38.tsv.gz


- T2D_Gaulton_26551672_1

Last Reviewed: 2020-02-11

I decided to redownload and reprocess this file because some undetermined bug (probably at liftover step) made me sent it to Specials
Something strange happened when I redownloaded the file from https://diagram-consortium.org/downloads.html (DIAGRAM Metabochip meta-analysis of T2D: Summary Statistics Published in Gaulton et al., Nature Genetics, 2015): The file didn't correspond to the file I had in 97-Archive.
In particular, this new downloaded file has way less SNPs (45943) compared to 127903 for the older.
Interesting, the README file I already had in 99-Technical_useful_files/ matched the Readme file associated to this new file.
I investigated this, including checking if perhaps they changed the available file for download, or if I downloaded it from GWAS catalog instead. Both questions turned out to be negative.
After checking the data in the paper and both the new and old T2D_Gaulton file, I determined to use the new file, since the numbers matched better the paper.
Thus, I manually edited the header, which was a bit messed up, and processed it. I kept the old T2D_Gaulton file in Archive for future inquiry.

However, this file still lacks SE, and will need to be calculated, so it went to Files_with_SE_issues

I also noticed that P was in scientific notation, and some of them didn't have even the E (see below):

               SNPID CHR38      BP38 CHR        BP ALT REF ALT_FREQ    OR OR_95L OR_95U       P N_EFFECTIVE     BETA
1:        rs34872471    10 112994312  10 114754071   C   T    0.261 1.386  1.348  1.425 5.3-119    73902.19 0.326422
2:        rs35198068    10 112995025  10 114754784   C   T    0.261 1.387  1.349  1.426 3.4-119    73902.22 0.327143
3:         rs7903146    10 112998590  10 114758349   T   C    0.260 1.388  1.351  1.427 5.8-120    73902.25 0.327864
4:        rs36090025    10 113014674  10 114774433   C   A    0.269 1.363  1.326  1.401 9.7-108    73901.87 0.309688
5: chr10:114782581:I    10 113022822  10 114782581   I   R    0.259 1.364  1.326  1.403 5.3-105    73901.98 0.310422
6:         rs7074440    10 113025665  10 114785424   A   G    0.269 1.356  1.320  1.394 4.2-105    73902.25 0.304539

I manually included the E using vim.


- VITD_Manousaki_28757204_1

Last Reviewed: 2020-02-10

The problem with this file is that it had some genomic coordinates expressed in scientific notation, making the LiftOver executable to crash.
As of pipeline v3, I included a line to replace these cases, so now it should work.
I took the file in Archive (VDL_Manousaki...), changed reference_allele to ALT and other_allele to REF, following the file's README at 99, and pipelined with v3.


- PSC_Ji_27992413_1

Last Reviewed: 2020-02-10

The problem with this file was that had a BETA column, but for some reason it was all NA. Since it had the headers, the bug run unnoticed.
To solve this, I used the following code

zcat PSC_Ji_27992413_1-hg38.tsv.gz | awk 'BEGIN{FS=OFS="\t"}NR>1{$26=log($22)}1' | gzip > PSC_Ji_27992413_1-bcorr.tsv.gz
cp PSC_Ji_27992413_1-bcorr.tsv.gz ../02-Processed/PSC_Ji_27992413_1-hg38.tsv.gz 
mv PSC_Ji_27992413_1-bcorr.tsv.gz ../To_reproject/PSC_Ji_27992413_1-hg38.tsv.gz


- RA_Okada_24390342_1 and RA_Okada_24390342_2 

Last Reviewed: 2020-02-10

These files lacked SE. While checking them at this stage, I realized that some positions hadn't been liftovered properly, probably due to bugs in previous versions of the pipeline.
So I repipelined them under v3 prior to SE calculation.
SE was successfully calculated using SE_Calc.R

- RA_Okada_24390342_3

Last Reviewed: 2020-02-10

The problem with this file was that had a BETA and SE columns, but for some reason they were both all NA. Since it had the headers, the bug run unnoticed.
To solve this, I used the following code

zcat RA_Okada_24390342_3-hg38.tsv.gz | awk 'BEGIN{FS=OFS="\t"}NR>1{$24=log($18)}1' | gzip > RA_Okada_24390342_3-bcorr.tsv.gz

For the SE calculation, I used SE_Calc.R on it



- Enroth_25147954

Last Reviewed: 2020-02-27

These files had SE missing. I realized that for some reason liftOver failed in these files, so I copied them from Archive, re-encoded allelles (A1 = ALT, A2 = REF) and repipelined.

mv B001_Enroth_25147954_1.tsv.gz CCL19_Enroth_25147954_1.tsv.gz
mv B002_Enroth_25147954_1.tsv.gz EOT2_Enroth_25147954_1.tsv.gz
mv B003_Enroth_25147954_1.tsv.gz CD40_Enroth_25147954_1.tsv.gz
mv B004_Enroth_25147954_1.tsv.gz IP10_Enroth_25147954_1.tsv.gz
mv B005_Enroth_25147954_1.tsv.gz CXCL5_Enroth_25147954_1.tsv.gz
mv B006_Enroth_25147954_1.tsv.gz EPCAM_Enroth_25147954_1.tsv.gz
mv B007_Enroth_25147954_1.tsv.gz ESEL_Enroth_25147954_1.tsv.gz
mv B008_Enroth_25147954_1.tsv.gz IL12_Enroth_25147954_1.tsv.gz
mv B009_Enroth_25147954_1.tsv.gz IL17RB_Enroth_25147954_1.tsv.gz
mv B010_Enroth_25147954_1.tsv.gz IL6RA_Enroth_25147954_1.tsv.gz
mv B011_Enroth_25147954_1.tsv.gz K11_Enroth_25147954_1.tsv.gz
mv B012_Enroth_25147954_1.tsv.gz MIA_Enroth_25147954_1.tsv.gz
mv B013_Enroth_25147954_1.tsv.gz MICA_Enroth_25147954_1.tsv.gz
mv B014_Enroth_25147954_1.tsv.gz VEGFD_Enroth_25147954_1.tsv.gz

In addition, I noticed a bug in the pipeline that would wrongly rename "sebeta_add_snp" as BETA. This was corrected in v4.3. I repipelined the files.


- MS_IMSGC_31604244_1

Last Reviewed: 2020-02-11

This file had SE missing. I realized that for some reason liftOver failed in this files, so I copied it from Archive, re-encoded allelles (A1 = ALT, A2 = REF) and repipelined.




- AIS_Kou_31417091_1, CD_Brant_27693347_1, EOE_Kottyan_25017104_1, IBD_Brant_27693347_1, IGAD_Bronson_27723758_1, MDD_CONVERGE_26176920_1, MS_IMSGC_30343897_1, MTX_Taylor_29795407_1, NMO_Estrada_29769526_1, NMOIGGn_Estrada_29769526_1, NMOIGGp_Estrada_29769526_1, PSO_Hirata_29031612_1, RA_Okada_24390342_1, RA_Okada_24390342_2, SLE_Julia_29848360_2, T2D_DIAGRAM_24509480_1, T2D_Gaulton_26551672_1, T2D_Morris_22885922_1, &  UC_Brant_27693347_1

Last Reviewed: 2020-02-11

These files lacked SE. I calculated it using SE_Calc.


- MDD_Wray_29700475_1

Last Reviewed: 2020-02-15

This file had a couple of problems. First, I mistakenly converted ';' (found in some SNPIDs) to tabs in the first versions of the pipeline, messing with the file structure. This was corrected by re-running. However, as explained in the Readme file, there are 62 SNPs in the middle of the file that are separated by spaces instead of tabs, and with less columns (12). Since the columns were in the same order than the rest of the file, I filled the missing columns in these 62 SNPs by NA using the following line. I repipelined afterwards. I updated the file in 97-Archive too.

zcat MDD_Wray_29700475_1.tsv.gz | awk 'BEGIN{OFS="\t"}{ for(i=NF+1; i<=19; i++) $i = "NA"; print}'  > tmp.tsv
gzip tmp.tsv && mv tmp.tsv.gz MDD_Wray_29700475_1.tsv.gz


- MSC_IMSGC_24076602_1

Last Reviewed: 2020-02-17

This file had two BP columns (18 and 19 builds). The 19 build was chosen for overlift, but it had some "unmapped" positions, while it had these positions for hg18.
I removed the hg19 column, renamed bp18 and reprocessed the file.

cp ../97-Archive/MSC_IMSGC_24076602_1.tsv.gz MS_IMSGC_24076602_1.tsv.gz
zcat MS_IMSGC_24076602_1.tsv.gz | awk '{$0=gensub(/\s*\S+/,"",3)}1' | sed '1s/BP18//' | gzip > tmp.tsv.gz && mv tmp.tsv.gz MS_IMSGC_24076602_1.tsv.gz


- SLE_SLEGEN_18204446_1.tsv.gz

Last Reviewed: 2020-02-20

For this file, it was unclear to me REF/ALT alleles. After a closer look at the paper, they call "Allele1" as minor allele, and OR seems to be referent to it, thus

cp ../97-Archive/SLE_SLEGEN_18204446_1.tsv.gz ./
zcat SLE_SLEGEN_18204446_1.tsv.gz | sed -e 's/Allele1/ALT/' -e 's/Allele2/REF/' | gzip > tmp.tsv.gz && mv tmp.tsv.gz SLE_SLEGEN_18204446_1.tsv.gz

And reprocessed the file.
During reduction, we realised that this file had a one-off error in it, rendering matches with manifest be zero.
Thus

cp ../97-Archive/SLE_SLEGEN_18204446_1.tsv.gz ./
zcat SLE_SLEGEN_18204446_1.tsv.gz | sed -e 's/Allele1/ALT/' -e 's/Allele2/REF/' | awk 'BEGIN{FS=OFS="\t"}!$4{$4 = "NA"}NR>1{if($4 != "NA") $4 = ($4 +1)}1' | gzip > tmp.tsv.gz && mv tmp.tsv.gz SLE_SLEGEN_18204446_1.tsv.gz

And reprocessed the file.


- PSO_Feng_19680446_1.tsv.gz

Last Reviewed: 2020-02-20

For this file, it was unclear to me REF/ALT alleles. After a closer look at the paper, OR seems to be referring to  "Allele1" thus

cp ../97-Archive/PSO_Feng_19680446_1.tsv.gz ./
zcat PSO_Feng_19680446_1.tsv.gz | sed -e 's/Allele1/ALT/' -e 's/Allele2/REF/' | gzip > tmp.tsv.gz && mv tmp.tsv.gz PSO_Feng_19680446_1.tsv.gz

And reprocessed the file.

During reduction, we realised that this file had a one-off error in it, rendering matches with manifest be zero.
Thus

cp ../97-Archive/PSO_Feng_19680446_1.tsv.gz ./
zcat PSO_Feng_19680446_1.tsv.gz | sed -e 's/Allele1/ALT/' -e 's/Allele2/REF/' | awk 'BEGIN{FS=OFS="\t"}!$4{$4 = "NA"}NR>1{if($4 != "NA") $4 = ($4 +1)}1' | gzip > tmp.tsv.gz && mv tmp.tsv.gz PSO_Feng_19680446_1.tsv.gz

And reprocessed the file using v4.
Because some SNPs lacked BP coordinates (and thus failed liftover), the join function behaved unexpectedly, not being able to match a number of SNPs (~800) despite having hg38 build coordinates in *lo-output2.bed.
I tried several things, including reordering files by SNPID, removing the initial missing SNPs...but I still couldn't understand what happened. 
The best I could get was by removing all SNPs with 0 at BP and then join. This yields a file with 267 unmatched SNPs (there were supposed to be 78).
To reproduce this error, follow previous steps and run pipeline v4.
What I did to improve the situation:

join -a2 -e'NA' -t $'\t' --nocheck-order -o auto PSO_Feng_19680446_1-lo-output2.bed <(awk '$4 != 0' tmp_formerging1.tsv) | gzip > PSO_Feng_19680446_1-hg38.tsv.gz


- MCH_Astle_27863252_1-hg38.tsv.gz,  MCHC_Astle_27863252_1-hg38.tsv.gz,  MCHC_Kanai_29403010_1-hg38.tsv.gz, & MCH_Kanai_29403010_1-hg38.tsv.gz

Last Reviewed: 2020-02-20

I found a tiny wee confusion at the name paradigm change step, since at some point I thought they were the same trait (Spoiler alert: They're not). 
This led to files having exactly the same name and overwriting, so I decided to reprocess them from the outset. The change in names from v1 to v2 is as follows:
CHC -> MCHC (Mean Corpuscular Hemoglobin Concentration)
MCH -> MCH (Mean Corpuscular Hemoglobin). No change.


- VIT_Jin_27723757_1-hg38.tsv.gz

Last Reviewed: 2020-02-21

I had to reprocess this file because I realized that column order was different in Chr1 than in the rest.

cp ../97-Archive/VIT_Jin_27723757_1.tsv.gz ./
zcat VIT_Jin_27723757_1.tsv.gz | awk 'BEGIN{FS=OFS="\t"}NR<653613{print $1, $2, $3, $4, $6, $5, $7, $8, $9, $10, $11, $12}NR>=653613{print $0}' | sed -e '1s/MAF/REF/' -e '1s/A1/ALT/' -e '1s/A2/MAF/' -e 's/RS/rs/' > VIT_Jin_27723757_1.tsv
gzip VIT_Jin_27723757_1.tsv

And reprocessed the file
I took the chance to make some improvements in pipeline, and created v4.1.

In addition, I realized that BETA calculation failed for some Chrs at the pipeline step (I noticed when searching for common significant SNPs, VIT_Jin file had an unusual amount of SNPs with BETA == NA).
I loaded the file into R, recalculated BETA doing VIT$BETA <- log(VIT$OR), and updated the file at 02-Processed/

- IGAN_Kiryluk_25305756_1.tsv.gz

Last Reviewed: 2020-02-21

This trait is one of those used to create the basis. But its projection didn't match those of the original (IgA_Neph). 
Investigating the original file I realized that there are two allele columns (Ref and Alt, and Allele1 and Allele2), but Beta makes reference to Allele1, and since some alleles in the Ref Alt columns, which I used for my projections were flipped, I got many wrongly oriented betas.
Thus, I reprocessed the file, removing these troublesome columns.

cp ../97-Archive/IAN_Kiryluk_25305756_1.tsv.gz ./
mv IAN_Kiryluk_25305756_1.tsv.gz IGAN_Kiryluk_25305756_1.tsv.gz
zcat IGAN_Kiryluk_25305756_1.tsv.gz | cut -d$'\t' -f1-2,4,7- | sed -e '1s/Allele1/ALT/' -e 's/Allele2/REF/' | gzip > tmp.tsv.gz && mv tmp.tsv.gz IGAN_Kiryluk_25305756_1.tsv.gz

And reprocessed with v4.1


- CD/IBD/UC_Brant_27693347_1 files

Last Reviewed: 2020-02-24

These files called our attention when I made the first exploratory plots, since they didn't cluster as expected. 
After a bit of investigation, I realised REF/ALT assingment was wrong. In the paper, A1 is called "tested" allele, and A2 is the "alternate allele", which made me think that A1 was the effect allele.
However, A2 seems to be ALT and A1 seems to be REF. 

zcat IBD_Brant_27693347_1-hg38.tsv.gz | sed -e '1s/ALT/tmp/' -e '1s/REF/ALT/' -e '1s/tmp/REF/' | gzip > tmp.tsv.gz && mv tmp.tsv.gz IBD_Brant_27693347_1-hg38.tsv.gz
zcat CD_Brant_27693347_1-hg38.tsv.gz | sed -e '1s/ALT/tmp/' -e '1s/REF/ALT/' -e '1s/tmp/REF/' | gzip > tmp.tsv.gz && mv tmp.tsv.gz CD_Brant_27693347_1-hg38.tsv.gz
zcat UC_Brant_27693347_1-hg38.tsv.gz | sed -e '1s/ALT/tmp/' -e '1s/REF/ALT/' -e '1s/tmp/REF/' | gzip > tmp.tsv.gz && mv tmp.tsv.gz UC_Brant_27693347_1-hg38.tsv.gz


- ASD_ASDWGPGC_28540026

Last Reviewed: 2020-02-25

While checking BETA correlations, I realized that these files were inverted compared to ASD_Grove datasets.
This was confirmed by reading the readme. A1 was classified as REF, but the readme says 
# a1 ............ reference allele 
# a2 ............ alternate allele
# or ............ odds ratio - derived from "effect", based on reference allele
So A1 should be ALT, instead of REF, as it was.
I manually corrected this using vim, and re-reduced the files for reprojection.

- HPxx_Wang_30092202_1

Last Reviewed: 2020-02-27

These files belong to the H2P2 project. The problem with them was that I was unsure of which BETA and Standard error to use, since it came with the following headers

Chr = CHR
Pos = BP
(CHR38 added)
(BP38 added)
MajorA	= REF
MinorA	= ALT
Beta	= BETA
EMP_Beta = EMP_BETA
EMP_se = EMP_SE
EMP1 = EMP_P
SNP = SNPID

However, it wasn't clear to me which BETA to use. I re-read the paper, and they used the QFAM-parents approach with adaptive permutation and a maximum of 109 permutations. The QFAM procedures implemented in PLINK use linear regression to test for association while employing permutation of within- and between-family components separately to control for family structure.
In addition:
"Simulation were carried out to estimate the genome-wide significance thresholds for H2P2 traits. For each cellular traits, we permutated the phenotype and ran family based association analysis using ‘‘qfam-parents’’ in PLINK 1.9. 
Following Kanai et al., 2016, we calibrated the empirical genome-wide significance threshold using the minimum p value from each simulation. 
We calculated the 90th percentile of the empirical distribution of log10Pmin using the Harrel-Davis estimator (Harrel and Davis, 1982) at a = 0.1, and the 95% confidence intervals of the quantile were obtained using 10000 bootstraps.

I decided to use EMP_BETA, EMP_SE and EMP1 for a start, so I created an script (HP_reheader.sh) to rehead these files appropriatedly.

- PBC_Nakamura_23000144_1

Last Reviewed: 2020-03-05

The harmonized file in GWAS catalog had some issues, so I decided to download the original file (ftp://ftp.ebi.ac.uk/pub/databases/gwas/summary_statistics/NakamuraM_23000144_GCST001685/hum0076_1stgwas_160916.csv) again.
This file had some particularities regarding alleles. BETA/OR refers to the minor allele, which changes depending on the SNP, there's a column specifying which one is the minor allele. 
I fixed it using an Rscript named Fix_PBC_Nakamura_23000144.R and repipelined (v4.4).



- EGPA/EGPAANCAn/EGPAMPO_Lyons_31719529_1.tsv.gz

Last Reviewed: 2020-03-10

The OR/BETA in the paper didn't quite match the ones in the files, probably due to some treatment given to the files during processing. Olly suggested adjusting BETA by the proportion of cases vs. controls. I wrote a script for this called Fix_Lyons.R.
This script calculates the adjusted BETA, OR, and SE for this study.
After that, I replaced ALLELE1 by ALT, and ALLELE0 by REF, and reprocessed the files.

